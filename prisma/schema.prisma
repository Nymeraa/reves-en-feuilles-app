generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Ingredient {
  id                  String          @id
  organizationId      String
  name                String
  slug                String
  category            String
  status              String          @default("ACTIVE")
  currentStock        Float           @default(0)
  weightedAverageCost Float           @default(0)
  supplierId          String?
  supplier            Supplier?       @relation(fields: [supplierId], references: [id])
  supplierUrl         String?
  alertThreshold      Float?
  notes               String?
  subtype             String?
  capacity            Float?
  capacityUnit        String?
  dimensions          String?
  unit                String?
  initialStock        Float?
  initialCost         Float?
  updatedAt           DateTime        @updatedAt
  packItems           PackItem[]
  recipeItems         RecipeItem[]
  movements           StockMovement[]

  @@index([organizationId])
  @@index([slug])
}

model Supplier {
  id                  String  @id
  organizationId      String
  name                String
  status              String  @default("ACTIVE")
  contactEmail        String?
  contactPhone        String?
  website             String?
  leadTime            Int?
  defaultConditioning String?
  notes               String?
  ingredients         Ingredient[]

  @@index([organizationId])
}

model Recipe {
  id                  String          @id
  organizationId      String
  name                String
  slug                String
  status              String          @default("ACTIVE")
  description         String?
  version             Int             @default(1)
  laborCost           Float           @default(0)
  packagingCost       Float           @default(0)
  totalIngredientCost Float           @default(0)
  totalCost           Float           @default(0)
  prices              Json            @default("{}")
  updatedAt           DateTime        @updatedAt
  packItems           PackItem[]
  items               RecipeItem[]
  versions            RecipeVersion[]

  @@index([organizationId])
}

model RecipeItem {
  id           String     @id
  recipeId     String
  ingredientId String
  percentage   Float
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([ingredientId])
}

model RecipeVersion {
  id                  String   @id
  recipeId            String
  organizationId      String
  name                String
  slug                String
  description         String?
  versionNumber       Int
  snapshotDate        DateTime
  status              String
  laborCost           Float
  packagingCost       Float
  totalIngredientCost Float
  totalCost           Float
  prices              Json     @default("{}")
  items               Json
  updatedAt           DateTime
  recipe              Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
}

model Pack {
  id             String        @id
  organizationId String
  name           String
  slug           String
  status         String        @default("ACTIVE")
  description    String?
  version        Int           @default(1)
  price          Float
  totalCost      Float         @default(0)
  margin         Float         @default(0)
  updatedAt      DateTime      @updatedAt
  items          PackItem[]
  versions       PackVersion[]

  @@index([organizationId])
}

model PackItem {
  id           String      @id
  packId       String
  type         String
  recipeId     String?
  ingredientId String?
  quantity     Float
  format       Float?
  ingredient   Ingredient? @relation(fields: [ingredientId], references: [id])
  pack         Pack        @relation(fields: [packId], references: [id], onDelete: Cascade)
  recipe       Recipe?     @relation(fields: [recipeId], references: [id])

  @@index([packId])
}

model PackVersion {
  id             String   @id
  packId         String
  organizationId String
  name           String
  slug           String
  description    String?
  versionNumber  Int
  snapshotDate   DateTime
  status         String
  price          Float
  totalCost      Float
  margin         Float
  recipes        Json
  packaging      Json
  updatedAt      DateTime
  pack           Pack     @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId])
}

model Order {
  id              String          @id
  organizationId  String
  orderNumber     String?
  customerName    String
  status          String          @default("DRAFT")
  totalAmount     Float
  totalCost       Float
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  paidAt          DateTime?
  cancelledAt     DateTime?
  packagingType   String?
  packagingId     String?
  cogsMaterials   Float           @default(0)
  cogsPackaging   Float           @default(0)
  netProfit       Float           @default(0)
  margin          Float           @default(0)
  feesUrssaf      Float           @default(0)
  feesShopify     Float           @default(0)
  feesOther       Float           @default(0)
  feesTotal       Float           @default(0)
  shippingCost    Float?          @default(0)
  shippingPrice   Float?
  source          String?
  email           String?
  shippingCarrier String?
  trackingNumber  String?
  discountCode    String?
  discountPercent Float?
  manualTotal     Boolean         @default(false)
  notes           String?
  items           OrderItem[]
  parcelWeightGrams Int?
  movements       StockMovement[]

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                        String  @id
  orderId                   String
  type                      String
  name                      String
  quantity                  Float
  recipeId                  String?
  packId                    String?
  ingredientId              String?
  format                    Float?
  versionNumber             Int?
  unitPriceSnapshot         Float
  unitCostSnapshot          Float
  unitMaterialCostSnapshot  Float   @default(0)
  unitPackagingCostSnapshot Float   @default(0)
  totalPrice                Float
  order                     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model StockMovement {
  id             String      @id
  organizationId String
  type           String
  entityType     String
  ingredientId   String?
  source         String
  sourceId       String?
  deltaQuantity  Float
  unitPrice      Float?
  totalPrice     Float?
  targetStock    Float?
  reason         String?
  createdAt      DateTime    @default(now())
  ingredient     Ingredient? @relation(fields: [ingredientId], references: [id])
  order          Order?      @relation(fields: [sourceId], references: [id])

  @@index([ingredientId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([sourceId])
}

model AuditLog {
  id            String   @id
  timestamp     DateTime @default(now())
  actorUserId   String?
  actorName     String?
  action        String
  entity        String
  entityId      String?
  severity      String   @default("INFO")
  correlationId String?
  metadata      Json?

  @@index([entityId])
  @@index([timestamp])
}

model Settings {
  id                        String @id @default("global")
  urssafRate                Float
  shopifyTransactionPercent Float
  shopifyFixedFee           Float
  defaultOtherFees          Float
  tvaIngredients            Float
  tvaPackaging              Float
}

model ActivityLog {
  id             String   @id
  organizationId String
  type           String
  entity         String
  entityId       String
  message        String
  user           String?
  timestamp      DateTime @default(now())

  @@index([organizationId])
  @@index([timestamp])
}
